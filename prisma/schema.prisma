generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Prize {
  id             String    @id @default(cuid())
  key            String    @unique
  label          String
  color          String?
  description    String?
  stock          Int?
  active         Boolean   @default(true)
  emittedTotal   Int       @default(0)
  lastEmittedAt  DateTime?
  isReusable     Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  assignedTokens Token[]   @relation("AssignedPrize")
  tokens         Token[]
}

model ReusablePrize {
  id          String          @id @default(cuid())
  key         String          @unique
  label       String
  color       String?
  description String?
  active      Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  tokens      ReusableToken[]

  @@index([key])
}

model ReusableToken {
  id                String        @id @default(cuid())
  prizeId           String
  expiresAt         DateTime
  createdAt         DateTime      @default(now())
  redeemedAt        DateTime?
  signature         String
  signatureVersion  Int           @default(1)
  disabled          Boolean       @default(false)
  deliveredAt       DateTime?
  deliveredByUserId String?
  deliveryNote      String?
  maxUses           Int           @default(1)
  usedCount         Int           @default(0)
  endTime           DateTime?
  startTime         DateTime?
  prize             ReusablePrize @relation(fields: [prizeId], references: [id])

  @@index([prizeId])
  @@index([expiresAt])
  @@index([redeemedAt])
  @@index([deliveredAt])
  @@index([startTime])
  @@index([endTime])
}

model Batch {
  id               String            @id @default(cuid())
  description      String?
  createdBy        String?
  createdAt        DateTime          @default(now())
  functionalDate   DateTime?
  staticTargetUrl  String?
  isReusable       Boolean           @default(false)
  rouletteSessions RouletteSession[]
  tokens           Token[]

  @@index([functionalDate])
  @@index([staticTargetUrl])
}

model Token {
  id                String    @id @default(cuid())
  prizeId           String
  batchId           String
  expiresAt         DateTime
  createdAt         DateTime  @default(now())
  redeemedAt        DateTime?
  signature         String
  signatureVersion  Int       @default(1)
  disabled          Boolean   @default(false)
  revealedAt        DateTime?
  assignedPrizeId   String?
  deliveredAt       DateTime?
  deliveredByUserId String?
  deliveryNote      String?
  ingestedAt        DateTime  @default(now())
  validFrom         DateTime?
  pairedNextTokenId String?
  maxUses           Int?
  usedCount         Int       @default(0)
  startTime         DateTime?
  endTime           DateTime?
  assignedPrize     Prize?    @relation("AssignedPrize", fields: [assignedPrizeId], references: [id])
  batch             Batch     @relation(fields: [batchId], references: [id])
  prize             Prize     @relation(fields: [prizeId], references: [id])

  @@index([prizeId])
  @@index([batchId])
  @@index([expiresAt])
  @@index([redeemedAt])
  @@index([revealedAt])
  @@index([deliveredAt])
  @@index([batchId, deliveredAt])
  @@index([ingestedAt])
  @@index([validFrom])
  @@index([pairedNextTokenId])
  @@index([batchId, revealedAt, redeemedAt, disabled, expiresAt])
}

model SystemConfig {
  id            Int      @id @default(autoincrement())
  tokensEnabled Boolean  @default(true)
  updatedAt     DateTime @updatedAt
}

model EventLog {
  id        String   @id @default(cuid())
  type      String
  message   String?
  metadata  String?
  createdAt DateTime @default(now())
}

model PrintTemplate {
  id              String   @id @default(cuid())
  name            String
  filePath        String?
  meta            String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  storageKey      String?
  storageProvider String?  @default("supabase")
  storageUrl      String?

  @@index([name])
}

model RouletteSession {
  id           String         @id @default(cuid())
  batchId      String
  mode         String         @default("BY_PRIZE")
  status       String         @default("ACTIVE")
  spins        Int            @default(0)
  maxSpins     Int?
  createdAt    DateTime       @default(now())
  finishedAt   DateTime?
  meta         String
  batch        Batch          @relation(fields: [batchId], references: [id])
  spinsHistory RouletteSpin[]

  @@index([batchId])
  @@index([status])
}

model RouletteSpin {
  id             String          @id @default(cuid())
  sessionId      String
  prizeId        String
  tokenId        String?
  weightSnapshot Int
  order          Int
  createdAt      DateTime        @default(now())
  session        RouletteSession @relation(fields: [sessionId], references: [id])

  @@unique([sessionId, order])
  @@index([sessionId])
  @@index([prizeId])
}

model Person {
  id               String             @id @default(cuid())
  code             String             @unique
  name             String
  active           Boolean            @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  dni              String?            @unique
  area             String?
  jobTitle         String?
  whatsapp         String?
  birthday         DateTime?          @db.Timestamp(6)
  PersonTaskStatus PersonTaskStatus[]
  scans            Scan[]
  user             User?

  @@index([code])
}

model Scan {
  id          String   @id @default(cuid())
  personId    String
  scannedAt   DateTime @default(now())
  type        String   @default("IN")
  deviceId    String?
  byUser      String?
  meta        String?
  createdAt   DateTime @default(now())
  businessDay String
  person      Person   @relation(fields: [personId], references: [id])

  @@index([personId])
  @@index([scannedAt])
  @@index([businessDay])
  @@index([businessDay, personId, type])
  @@index([personId, businessDay])
}

model User {
  id                        String                 @id @default(cuid())
  username                  String                 @unique
  passwordHash              String
  role                      String                 @default("COLLAB")
  personId                  String                 @unique
  forcePasswordChange       Boolean                @default(false)
  createdAt                 DateTime               @default(now())
  updatedAt                 DateTime               @updatedAt
  commitmentVersionAccepted Int                    @default(0)
  commitmentAcceptedAt      DateTime?              @db.Timestamp(6)
  ChecklistComment          ChecklistComment[]
  ChecklistTaskComment      ChecklistTaskComment[]
  offerPurchases            OfferPurchase[]
  passwordResetOtps         PasswordResetOtp[]
  updatedTaskStatuses       PersonTaskStatus[]     @relation("TaskStatusUpdatedBy")
  TaskComment               TaskComment[]
  ticketPurchases           TicketPurchase[]
  person                    Person                 @relation(fields: [personId], references: [id])

  @@index([commitmentVersionAccepted], map: "idx_user_commitment_version")
}

model Customer {
  id              String           @id @default(cuid())
  dni             String           @unique
  name            String
  email           String?          @unique
  phone           String
  whatsapp        String?
  birthday        DateTime?        @db.Timestamp(6)
  membershipLevel String           @default("MEMBER")
  points          Int              @default(0)
  totalSpent      Float            @default(0)
  visitCount      Int              @default(0)
  lastVisit       DateTime?
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  customerVisits  CustomerVisit[]
  orders          Order[]
  ticketPurchases TicketPurchase[]

  @@index([dni])
  @@index([email])
  @@index([membershipLevel])
  @@index([isActive])
}

model CustomerVisit {
  id           String   @id @default(cuid())
  customerId   String
  visitDate    DateTime @default(now())
  visitType    String   @default("VISIT")
  notes        String?
  spent        Float    @default(0)
  pointsEarned Int      @default(0)
  createdAt    DateTime @default(now())
  customer     Customer @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([visitDate])
}

model Task {
  id             String             @id @default(cuid())
  label          String
  active         Boolean            @default(true)
  sortOrder      Int                @default(0)
  priority       Int                @default(0)
  completed      Boolean            @default(false)
  measureEnabled Boolean            @default(false)
  targetValue    Int?
  unitLabel      String?
  startDay       String?
  endDay         String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  area           String?
  statuses       PersonTaskStatus[]
  TaskComment    TaskComment[]

  @@index([area])
  @@index([startDay])
  @@index([endDay])
}

model PersonTaskStatus {
  id           String   @id @default(cuid())
  personId     String
  taskId       String
  day          String
  done         Boolean  @default(false)
  measureValue Int      @default(0)
  updatedBy    String?
  updatedAt    DateTime @updatedAt
  person       Person   @relation(fields: [personId], references: [id])
  task         Task     @relation(fields: [taskId], references: [id])
  user         User?    @relation("TaskStatusUpdatedBy", fields: [updatedBy], references: [id])

  @@unique([personId, taskId, day])
  @@index([personId])
  @@index([taskId])
  @@index([day])
  @@index([day, done])
}

model BirthdayPack {
  id           String                @id @default(cuid())
  name         String                @unique
  qrCount      Int
  bottle       String
  perks        String
  active       Boolean               @default(true)
  featured     Boolean               @default(false)
  priceSoles   Int                   @default(0)
  isCustom     Boolean               @default(false)
  reservations BirthdayReservation[]

  @@index([active])
  @@index([featured])
}

model BirthdayReservation {
  id                String             @id @default(cuid())
  celebrantName     String
  phone             String
  documento         String
  email             String?
  date              DateTime
  timeSlot          String
  packId            String
  guestsPlanned     Int
  status            String             @default("draft")
  tokensGeneratedAt DateTime?
  createdBy         String?
  updatedBy         String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  hostArrivedAt     DateTime?          @db.Timestamp(6)
  guestArrivals     Int                @default(0)
  referrerId        String?
  pack              BirthdayPack       @relation(fields: [packId], references: [id])
  referrer          BirthdayReferrer?  @relation(fields: [referrerId], references: [id])
  courtesyItems     CourtesyItem[]
  inviteTokens      InviteToken[]
  photoDeliveries   PhotoDeliverable[]
  redemptions       TokenRedemption[]

  @@index([packId])
  @@index([date, timeSlot])
  @@index([status])
  @@index([hostArrivedAt])
  @@index([referrerId])
}

model BirthdayReferrer {
  id               String                @id @default(cuid())
  name             String
  slug             String                @unique
  code             String                @unique
  email            String?
  phone            String?
  commissionAmount Decimal?              @default(10.00) @db.Decimal(10, 2)
  active           Boolean               @default(true)
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  reservations     BirthdayReservation[]

  @@index([slug])
  @@index([active])
}

model InviteToken {
  id            String              @id @default(cuid())
  reservationId String
  code          String              @unique
  kind          String              @default("guest")
  status        String              @default("unclaimed")
  expiresAt     DateTime
  claim         String
  metadata      String?
  usedCount     Int                 @default(0)
  maxUses       Int?
  createdAt     DateTime            @default(now())
  reservation   BirthdayReservation @relation(fields: [reservationId], references: [id])
  card          InviteTokenCard?
  redemptions   TokenRedemption[]

  @@index([reservationId])
  @@index([status])
  @@index([expiresAt])
}

model InviteTokenCard {
  id              String      @id @default(cuid())
  inviteTokenId   String      @unique
  kind            String
  filePath        String?
  createdAt       DateTime    @default(now())
  storageKey      String?
  storageProvider String?     @default("supabase")
  storageUrl      String?
  inviteToken     InviteToken @relation(fields: [inviteTokenId], references: [id], onDelete: Cascade)

  @@index([kind])
  @@index([createdAt])
}

model TokenRedemption {
  id            String               @id @default(cuid())
  tokenId       String
  redeemedAt    DateTime             @default(now())
  by            String?
  device        String?
  location      String?
  reservationId String?
  reservation   BirthdayReservation? @relation(fields: [reservationId], references: [id])
  token         InviteToken          @relation(fields: [tokenId], references: [id])

  @@index([tokenId])
  @@index([redeemedAt])
  @@index([reservationId])
}

model CourtesyItem {
  id            String              @id @default(cuid())
  reservationId String
  type          String
  status        String              @default("pending")
  notes         String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  reservation   BirthdayReservation @relation(fields: [reservationId], references: [id])

  @@index([reservationId])
  @@index([type])
  @@index([status])
}

model PhotoDeliverable {
  id            String              @id @default(cuid())
  reservationId String
  kind          String              @default("group")
  url           String?
  status        String              @default("pending")
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  reservation   BirthdayReservation @relation(fields: [reservationId], references: [id])

  @@index([reservationId])
  @@index([status])
}

model PasswordResetOtp {
  id        String    @id @default(cuid())
  userId    String
  code      String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([code])
  @@index([expiresAt])
}

model DayBrief {
  id        String   @id @default(cuid())
  day       String   @unique
  title     String?
  show      String?
  promos    String?
  notes     String?
  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([day])
}

model Show {
  id                String       @id @default(cuid())
  title             String       @db.VarChar(120)
  slug              String       @unique @db.VarChar(140)
  status            ShowStatus   @default(DRAFT)
  startsAt          DateTime
  endsAt            DateTime?
  slot              Int?         @db.SmallInt
  imageOriginalPath String
  imageWebpPath     String
  imageBlurData     String
  width             Int
  height            Int
  bytesOriginal     Int
  bytesOptimized    Int
  publishedAt       DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  details           String?
  notes             String?
  specialGuests     String?
  ticketTypes       TicketType[]

  @@index([status, startsAt(sort: Desc)])
}

model TicketType {
  id             String           @id @default(cuid())
  showId         String
  name           String           @db.VarChar(100)
  description    String?
  price          Decimal          @db.Decimal(10, 2)
  capacity       Int
  soldCount      Int              @default(0)
  availableFrom  DateTime?
  availableTo    DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  tickets        Ticket[]
  ticketPackages TicketPackage[]
  purchases      TicketPurchase[]
  show           Show             @relation(fields: [showId], references: [id], onDelete: Cascade)

  @@index([showId])
  @@index([availableFrom, availableTo])
}

model TicketPurchase {
  id            String         @id @default(cuid())
  userId        String?
  customerId    String?
  ticketTypeId  String
  quantity      Int
  totalAmount   Decimal        @db.Decimal(10, 2)
  status        PurchaseStatus @default(PENDING)
  paymentId     String?
  culqiOrderId  String?
  paymentStatus String         @default("pending")
  purchasedAt   DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  customerName  String
  customerEmail String?
  customerPhone String
  customerDni   String?
  tickets       Ticket[]
  ticketPackage TicketPackage?
  customer      Customer?      @relation(fields: [customerId], references: [id])
  ticketType    TicketType     @relation(fields: [ticketTypeId], references: [id])
  user          User?          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([customerId])
  @@index([ticketTypeId])
  @@index([status])
  @@index([culqiOrderId])
}

model Ticket {
  id               String         @id @default(cuid())
  ticketPurchaseId String
  ticketTypeId     String
  qrCode           String
  qrDataUrl        String?
  customerDni      String
  customerName     String
  customerPhone    String
  status           TicketStatus   @default(VALID)
  createdAt        DateTime       @default(now())
  usedAt           DateTime?
  ticketPurchase   TicketPurchase @relation(fields: [ticketPurchaseId], references: [id])
  ticketType       TicketType     @relation(fields: [ticketTypeId], references: [id])

  @@index([ticketPurchaseId])
  @@index([qrCode])
  @@index([status])
}

model TicketPackage {
  id               String         @id @default(cuid())
  ticketPurchaseId String         @unique
  ticketTypeId     String
  qrCode           String         @unique
  qrDataUrl        String?
  totalTickets     Int
  usedTickets      Int            @default(0)
  customerDni      String
  customerName     String
  customerPhone    String
  status           PurchaseStatus @default(CONFIRMED)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  ticketPurchase   TicketPurchase @relation(fields: [ticketPurchaseId], references: [id], onDelete: Cascade)
  ticketType       TicketType     @relation(fields: [ticketTypeId], references: [id], onDelete: Cascade)

  @@index([ticketPurchaseId])
  @@index([qrCode])
  @@index([status])
}

model ChecklistComment {
  id        String   @id
  userId    String
  day       String
  text      String
  createdAt DateTime @default(now()) @db.Timestamp(6)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([day])
  @@index([userId])
}

model ChecklistTaskComment {
  id        String   @id
  userId    String
  taskId    String
  day       String
  text      String
  createdAt DateTime @default(now()) @db.Timestamp(6)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([day])
  @@index([taskId], map: "ChecklistTaskComment_task_idx")
  @@index([userId])
}

model TaskComment {
  id        String   @id
  userId    String
  taskId    String
  day       String
  text      String
  createdAt DateTime @default(now()) @db.Timestamp(6)
  Task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([day])
  @@index([taskId, day])
  @@index([userId])
}

model birthdaypack {
  id       String  @id
  name     String? @unique
  qrcount  Int
  bottle   String
  perks    String
  active   Int     @default(1)
  featured Int     @default(0)
}

model Category {
  id               String    @id @default(cuid())
  name             String
  description      String?
  icon             String?
  image            String?
  imageStorageKey  String?
  storageProvider  String?   @default("supabase")
  order            Int       @default(0)
  active           Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  products         Product[]

  @@index([order])
  @@index([active])
}

model Product {
  id               String           @id @default(cuid())
  name             String
  description      String?
  price            Float
  basePrice        Float?
  image            String?
  imageStorageKey  String?
  storageProvider  String?          @default("supabase")
  categoryId       String
  available        Boolean          @default(true)
  featured         Boolean          @default(false)
  order            Int              @default(0)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  sku              String?
  barcode          String?
  taxRate          Float            @default(0.12)
  costPrice        Float?
  minStock         Int              @default(0)
  maxStock         Int?
  unitOfMeasureId  String?
  allergens        String?
  nutritionalInfo  String?
  inventoryItems   InventoryItem[]
  orderItems       OrderItem[]
  category         Category         @relation(fields: [categoryId], references: [id])
  unitOfMeasure    UnitOfMeasure?   @relation(fields: [unitOfMeasureId], references: [id])
  variants         ProductVariant[]

  @@index([categoryId])
  @@index([available])
  @@index([featured])
  @@index([order])
}

model Table {
  id        String   @id @default(cuid())
  number    Int      @unique
  name      String?
  zone      String?
  capacity  Int      @default(4)
  active    Boolean  @default(true)
  qrCode    String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orders    Order[]

  @@index([zone])
  @@index([active])
}

model Location {
  id            String         @id @default(cuid())
  name          String
  type          LocationType
  active        Boolean        @default(true)
  order         Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  orders        Order[]
  servicePoints ServicePoint[]

  @@index([type])
  @@index([active])
  @@index([order])
}

model ServicePoint {
  id         String           @id @default(cuid())
  locationId String
  number     String
  name       String?
  type       ServicePointType
  capacity   Int              @default(4)
  active     Boolean          @default(true)
  qrCode     String?          @unique
  positionX  Int?
  positionY  Int?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  orders     Order[]
  location   Location         @relation(fields: [locationId], references: [id])

  @@index([locationId])
  @@index([type])
  @@index([active])
}

model Staff {
  id        String    @id @default(cuid())
  userId    String    @unique
  name      String
  role      StaffRole
  active    Boolean   @default(true)
  zones     String[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  orders    Order[]

  @@index([role])
  @@index([active])
}

model Order {
  id             String        @id @default(cuid())
  tableId        String?
  servicePointId String?
  locationId     String?
  staffId        String?
  customerId     String?
  customerName   String?
  isFromQR       Boolean       @default(false)
  status         OrderStatus   @default(PENDING)
  total          Float         @default(0)
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  confirmedAt    DateTime?
  readyAt        DateTime?
  deliveredAt    DateTime?
  customer       Customer?     @relation(fields: [customerId], references: [id])
  location       Location?     @relation(fields: [locationId], references: [id])
  servicePoint   ServicePoint? @relation(fields: [servicePointId], references: [id])
  staff          Staff?        @relation(fields: [staffId], references: [id])
  table          Table?        @relation(fields: [tableId], references: [id])
  items          OrderItem[]

  @@index([tableId])
  @@index([servicePointId])
  @@index([locationId])
  @@index([staffId])
  @@index([customerId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id         String          @id @default(cuid())
  orderId    String
  productId  String
  quantity   Int             @default(1)
  price      Float
  unitPrice  Float?
  totalPrice Float?
  notes      String?
  variantId  String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @default(now()) @updatedAt
  order      Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product    Product         @relation(fields: [productId], references: [id])
  variant    ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String
  recipient String?
  sender    String?
  orderId   String?
  read      Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  @@index([recipient])
  @@index([type])
  @@index([read])
  @@index([createdAt])
}

model UnitOfMeasure {
  id        String           @id @default(cuid())
  name      String
  symbol    String
  type      String
  active    Boolean          @default(true)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  products  Product[]
  variants  ProductVariant[]

  @@index([type])
  @@index([active])
}

model Supplier {
  id             String          @id @default(cuid())
  name           String
  contactName    String?
  email          String?
  phone          String?
  address        String?
  taxId          String?
  active         Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  inventoryItems InventoryItem[]

  @@index([active])
}

model ProductVariant {
  id              String          @id @default(cuid())
  productId       String
  name            String
  multiplier      Float           @default(1.0)
  sku             String?         @unique
  barcode         String?         @unique
  active          Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  unitOfMeasureId String?
  inventoryItems  InventoryItem[]
  orderItems      OrderItem[]
  product         Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  unitOfMeasure   UnitOfMeasure?  @relation(fields: [unitOfMeasureId], references: [id])

  @@index([productId])
  @@index([active])
  @@index([sku])
  @@index([barcode])
}

model InventoryItem {
  id            String          @id @default(cuid())
  productId     String?
  variantId     String?
  supplierId    String?
  batchNumber   String?
  purchaseDate  DateTime
  expiryDate    DateTime?
  quantity      Float
  unitCost      Float
  totalCost     Float
  currentStock  Float           @default(0)
  reservedStock Float           @default(0)
  damagedStock  Float           @default(0)
  minStock      Float           @default(0)
  maxStock      Float?
  location      String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  product       Product?        @relation(fields: [productId], references: [id])
  supplier      Supplier?       @relation(fields: [supplierId], references: [id])
  variant       ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([productId])
  @@index([variantId])
  @@index([supplierId])
  @@index([expiryDate])
  @@index([batchNumber])
}

model Offer {
  id            String          @id @default(cuid())
  title         String          @db.VarChar(100)
  description   String?
  shortDesc     String?         @db.VarChar(200)
  price         Decimal         @db.Decimal(10, 2)
  originalPrice Decimal?        @db.Decimal(10, 2)
  discount      Int?
  imagePath     String
  imageWebpPath String
  imageBlurData String
  width         Int
  height        Int
  isActive      Boolean         @default(true)
  validFrom     DateTime?
  validUntil    DateTime?
  timezone      String          @default("America/Lima")
  availableDays Int[]
  startTime     String?
  endTime       String?
  maxQuantity   Int?
  soldCount     Int             @default(0)
  category      String?         @db.VarChar(50)
  tags          String[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  purchases     OfferPurchase[]

  @@index([isActive, validFrom, validUntil])
  @@index([category])
}

model OfferPurchase {
  id               String              @id @default(cuid())
  offerId          String
  userId           String?
  customerName     String
  customerEmail    String?
  customerPhone    String
  customerWhatsapp String?
  customerDni      String?
  amount           Decimal             @db.Decimal(10, 2)
  currency         String              @default("PEN")
  quantity         Int                 @default(1)
  status           OfferPurchaseStatus @default(PENDING)
  culqiChargeId    String?
  culqiPaymentId   String?
  paymentStatus    String              @default("pending")
  qrCode           String?             @unique
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  offer            Offer               @relation(fields: [offerId], references: [id])
  user             User?               @relation(fields: [userId], references: [id])

  @@index([offerId])
  @@index([userId])
  @@index([status])
}

model TriviaQuestion {
  id            String             @id @default(cuid())
  question      String
  order         Int                @default(0)
  active        Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  questionSetId String?
  answers       TriviaAnswer[]
  progress      TriviaProgress[]
  questionSet   TriviaQuestionSet? @relation(fields: [questionSetId], references: [id])

  @@index([order])
  @@index([active])
  @@index([questionSetId])
}

model TriviaAnswer {
  id         String           @id @default(cuid())
  questionId String
  answer     String
  isCorrect  Boolean          @default(false)
  order      Int              @default(0)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  question   TriviaQuestion   @relation(fields: [questionId], references: [id], onDelete: Cascade)
  progress   TriviaProgress[]

  @@index([questionId])
  @@index([isCorrect])
}

model TriviaSession {
  id                   String            @id @default(cuid())
  sessionId            String            @unique
  questionSetId        String
  currentQuestionIndex Int               @default(0)
  completed            Boolean           @default(false)
  prizeId              String?
  startedAt            DateTime          @default(now())
  completedAt          DateTime?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  progress             TriviaProgress[]
  prize                TriviaPrize?      @relation(fields: [prizeId], references: [id])
  questionSet          TriviaQuestionSet @relation(fields: [questionSetId], references: [id])

  @@index([sessionId])
  @@index([completed])
  @@index([prizeId])
  @@index([questionSetId])
}

model TriviaProgress {
  id               String         @id @default(cuid())
  sessionId        String
  questionId       String
  selectedAnswerId String?
  isCorrect        Boolean?
  answeredAt       DateTime       @default(now())
  createdAt        DateTime       @default(now())
  question         TriviaQuestion @relation(fields: [questionId], references: [id])
  selectedAnswer   TriviaAnswer?  @relation(fields: [selectedAnswerId], references: [id])
  session          TriviaSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, questionId])
  @@index([sessionId])
  @@index([questionId])
  @@index([isCorrect])
}

model TriviaQuestionSet {
  id          String           @id @default(cuid())
  name        String
  description String?
  active      Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  prizes      TriviaPrize[]
  questions   TriviaQuestion[]
  sessions    TriviaSession[]

  @@index([active])
}

model TriviaPrize {
  id            String            @id @default(cuid())
  name          String
  description   String?
  qrCode        String
  imageUrl      String?
  value         Float?
  validFrom     DateTime
  validUntil    DateTime
  questionSetId String
  active        Boolean           @default(true)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  questionSet   TriviaQuestionSet @relation(fields: [questionSetId], references: [id])
  sessions      TriviaSession[]

  @@unique([questionSetId, qrCode])
  @@index([questionSetId])
  @@index([active])
  @@index([validFrom])
  @@index([validUntil])
}

model CustomQr {
  id               String         @id @default(cuid())
  customerName     String
  customerWhatsapp String
  customerPhrase   String?
  customData       String?
  theme            String         @default("default")
  qrColor          String?
  backgroundColor  String?
  code             String         @unique
  signature        String
  signatureVersion Int            @default(1)
  isActive         Boolean        @default(true)
  expiresAt        DateTime?
  createdAt        DateTime       @default(now())
  redeemedAt       DateTime?
  redeemedBy       String?
  batchId          String?
  campaignName     String?
  metadata         String?
  ipAddress        String?
  userAgent        String?
  expiryPolicy     String?
  extendedCount    Int            @default(0)
  lastExtendedAt   DateTime?
  revokeReason     String?
  revokedAt        DateTime?
  revokedBy        String?
  imageMetadata    String?
  imageUrl         String?
  originalImageUrl String?
  thumbnailUrl     String?
  customerDni      String?
  batch            CustomQrBatch? @relation(fields: [batchId], references: [id])

  @@index([code])
  @@index([isActive])
  @@index([batchId])
  @@index([campaignName])
  @@index([expiresAt])
  @@index([createdAt])
  @@index([expiryPolicy])
}

model CustomQrBatch {
  id          String     @id @default(cuid())
  name        String
  description String?
  theme       String     @default("default")
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  qrs         CustomQr[]

  @@index([isActive])
  @@index([createdAt])
}

model CustomQrPolicy {
  id                  String   @id @default(cuid())
  name                String
  description         String?
  defaultExpiryDate   DateTime?
  maxExtensions       Int      @default(1)
  extensionExpiryDate DateTime?
  allowCustomData     Boolean  @default(true)
  allowCustomPhrase   Boolean  @default(true)
  allowCustomColors   Boolean  @default(true)
  rateLimitPerHour    Int?
  maxQrsPerUser       Int?
  requireApproval     Boolean  @default(false)
  isActive            Boolean  @default(true)
  isDefault           Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  allowImageUpload    Boolean  @default(true)
  allowedImageFormats String   @default("jpg,jpeg,png,webp")
  imageQuality        Int      @default(80)
  maxImageHeight      Int      @default(1200)
  maxImageSize        Int      @default(5242880)
  maxImageWidth       Int      @default(1200)
  defaultTheme        String   @default("default")
  allowDni            Boolean  @default(false)
  defaultBatchId      String?
  requireDni          Boolean  @default(false)
  requireWhatsapp     Boolean  @default(true)
  requireUniqueDni    Boolean  @default(false)
  requireImageUpload  Boolean  @default(false)

  @@index([isActive])
  @@index([isDefault])
}

enum PurchaseStatus {
  PENDING
  CONFIRMED
  CANCELLED
  REFUNDED
  SUSPICIOUS
}

enum TicketStatus {
  VALID
  USED
  CANCELLED
}

enum ShowStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum LocationType {
  DINING
  VIP
  BAR
}

enum ServicePointType {
  TABLE
  BOX
  ZONE
}

enum StaffRole {
  WAITER
  CASHIER
  ADMIN
  BARTENDER
  SECURITY
  ANIMATION
  DJ
  MULTIMEDIA
  GENERAL_STAFF
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  DELIVERED
  CANCELLED
}

enum NotificationType {
  ORDER_NEW
  ORDER_CONFIRMED
  ORDER_READY
  ORDER_DELIVERED
  ORDER_CANCELLED
  STAFF_ALERT
  SYSTEM_MESSAGE
}

enum OfferPurchaseStatus {
  PENDING
  CONFIRMED
  CANCELLED
  REFUNDED
  EXPIRED
}

model Survive2025Run {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now()) @map("created_at")
  eventId      String   @map("event_id")
  displayName  String   @map("display_name")
  bestMs       Int      @map("best_ms")
  score        Int
  deviceHash   String?  @map("device_hash")
  sessionId    String?  @map("session_id")
  meta         Json?

  @@index([eventId, score(sort: Desc), bestMs(sort: Desc)])
  @@map("survive2025_runs")
}
