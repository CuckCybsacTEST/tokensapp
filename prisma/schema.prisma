generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Prize {
  id             String    @id @default(cuid())
  key            String    @unique
  label          String
  color          String?
  description    String?
  stock          Int?
  active         Boolean   @default(true)
  emittedTotal   Int       @default(0)
  lastEmittedAt  DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  assignedTokens Token[]   @relation("AssignedPrize")
  tokens         Token[]
}

model Batch {
  id               String            @id @default(cuid())
  description      String?
  createdBy        String?
  createdAt        DateTime          @default(now())
  functionalDate   DateTime?
  staticTargetUrl  String?           // If present, this batch is a static redirect batch
  rouletteSessions RouletteSession[]
  tokens           Token[]

  @@index([functionalDate])
  @@index([staticTargetUrl])
}

model Token {
  id                String    @id @default(cuid())
  prizeId           String
  batchId           String
  expiresAt         DateTime
  createdAt         DateTime  @default(now())
  redeemedAt        DateTime?
  signature         String
  signatureVersion  Int       @default(1)
  disabled          Boolean   @default(false)
  revealedAt        DateTime?
  assignedPrizeId   String?
  deliveredAt       DateTime?
  deliveredByUserId String?
  deliveryNote      String?
  ingestedAt        DateTime  @default(now())
  validFrom         DateTime?
  // Pre-linked next token for "retry" control (optional, for printing determinism)
  pairedNextTokenId String?
  assignedPrize     Prize?    @relation("AssignedPrize", fields: [assignedPrizeId], references: [id])
  batch             Batch     @relation(fields: [batchId], references: [id])
  prize             Prize     @relation(fields: [prizeId], references: [id])

  @@index([prizeId])
  @@index([batchId])
  @@index([expiresAt])
  @@index([redeemedAt])
  @@index([revealedAt])
  @@index([deliveredAt])
  @@index([batchId, deliveredAt])
  @@index([ingestedAt])
  @@index([validFrom])
  @@index([pairedNextTokenId])
}

model SystemConfig {
  id            Int      @id @default(autoincrement())
  tokensEnabled Boolean  @default(true)
  updatedAt     DateTime @updatedAt
}

model EventLog {
  id        String   @id @default(cuid())
  type      String
  message   String?
  metadata  String?
  createdAt DateTime @default(now())
}

model PrintTemplate {
  id        String   @id @default(cuid())
  name      String
  filePath  String
  meta      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

model RouletteSession {
  id           String         @id @default(cuid())
  batchId      String
  mode         String         @default("BY_PRIZE")
  status       String         @default("ACTIVE")
  spins        Int            @default(0)
  maxSpins     Int?
  createdAt    DateTime       @default(now())
  finishedAt   DateTime?
  meta         String
  batch        Batch          @relation(fields: [batchId], references: [id])
  spinsHistory RouletteSpin[]

  @@index([batchId])
  @@index([status])
}

model RouletteSpin {
  id             String          @id @default(cuid())
  sessionId      String
  prizeId        String
  tokenId        String?
  weightSnapshot Int
  order          Int
  createdAt      DateTime        @default(now())
  session        RouletteSession @relation(fields: [sessionId], references: [id])

  @@unique([sessionId, order])
  @@index([sessionId])
  @@index([prizeId])
}

model Person {
  id               String             @id @default(cuid())
  code             String             @unique
  name             String
  active           Boolean            @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  dni              String?            @unique
  area             String?
  jobTitle         String?
  whatsapp         String?
  birthday         DateTime?          @db.Timestamp(6)
  PersonTaskStatus PersonTaskStatus[]
  scans            Scan[]
  user             User?

  @@index([code])
}

model Scan {
  id          String   @id @default(cuid())
  personId    String
  scannedAt   DateTime @default(now())
  type        String   @default("IN")
  deviceId    String?
  byUser      String?
  meta        String?
  createdAt   DateTime @default(now())
  businessDay String
  person      Person   @relation(fields: [personId], references: [id])

  @@index([personId])
  @@index([scannedAt])
  @@index([businessDay])
  @@index([businessDay, personId, type])
  @@index([personId, businessDay])
}

model User {
  id                        String                 @id @default(cuid())
  username                  String                 @unique
  passwordHash              String
  role                      String                 @default("COLLAB")
  personId                  String                 @unique
  createdAt                 DateTime               @default(now())
  updatedAt                 DateTime               @updatedAt
  commitmentVersionAccepted Int                    @default(0)
  commitmentAcceptedAt      DateTime?              @db.Timestamp(6)
  ChecklistComment          ChecklistComment[]
  ChecklistTaskComment      ChecklistTaskComment[]
  passwordResetOtps         PasswordResetOtp[]
  updatedTaskStatuses       PersonTaskStatus[]     @relation("TaskStatusUpdatedBy")
  TaskComment               TaskComment[]
  person                    Person                 @relation(fields: [personId], references: [id])

  @@index([commitmentVersionAccepted], map: "idx_user_commitment_version")
}

model Task {
  id             String             @id @default(cuid())
  label          String
  active         Boolean            @default(true)
  sortOrder      Int                @default(0)
  priority       Int                @default(0)
  completed      Boolean            @default(false)
  measureEnabled Boolean            @default(false)
  targetValue    Int?
  unitLabel      String?
  startDay       String?
  endDay         String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  area           String?
  statuses       PersonTaskStatus[]
  TaskComment    TaskComment[]

  @@index([area])
}

model PersonTaskStatus {
  id           String   @id @default(cuid())
  personId     String
  taskId       String
  day          String
  done         Boolean  @default(false)
  measureValue Int      @default(0)
  updatedBy    String?
  updatedAt    DateTime @updatedAt
  person       Person   @relation(fields: [personId], references: [id])
  task         Task     @relation(fields: [taskId], references: [id])
  user         User?    @relation("TaskStatusUpdatedBy", fields: [updatedBy], references: [id])

  @@unique([personId, taskId, day])
  @@index([personId])
  @@index([taskId])
  @@index([day])
}

model BirthdayPack {
  id           String                @id @default(cuid())
  name         String                @unique
  qrCount      Int
  bottle       String
  perks        String
  active       Boolean               @default(true)
  featured     Boolean               @default(false)
  priceSoles   Int                   @default(0) // Precio entero en soles (sin decimales)
  isCustom     Boolean               @default(false) // Pack placeholder / personalizado interno
  reservations BirthdayReservation[]

  @@index([active])
  @@index([featured])
}

model BirthdayReservation {
  id                String             @id @default(cuid())
  celebrantName     String
  phone             String
  documento         String
  email             String?
  date              DateTime
  timeSlot          String
  packId            String
  guestsPlanned     Int
  status            String             @default("draft")
  tokensGeneratedAt DateTime?
  createdBy         String?
  updatedBy         String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  hostArrivedAt     DateTime?          @db.Timestamp(6)
  guestArrivals     Int                @default(0)
  pack              BirthdayPack       @relation(fields: [packId], references: [id])
  courtesyItems     CourtesyItem[]
  inviteTokens      InviteToken[]
  photoDeliveries   PhotoDeliverable[]
  redemptions       TokenRedemption[]

  @@index([packId])
  @@index([date, timeSlot])
  @@index([status])
  @@index([hostArrivedAt])
}

model InviteToken {
  id            String              @id @default(cuid())
  reservationId String
  code          String              @unique
  kind          String              @default("guest")
  status        String              @default("unclaimed")
  expiresAt     DateTime
  claim         String
  metadata      String?
  usedCount     Int                 @default(0)
  maxUses       Int?
  createdAt     DateTime            @default(now())
  reservation   BirthdayReservation @relation(fields: [reservationId], references: [id])
  redemptions   TokenRedemption[]
  card          InviteTokenCard?

  @@index([reservationId])
  @@index([status])
  @@index([expiresAt])
}

model InviteTokenCard {
  id            String      @id @default(cuid())
  inviteTokenId String      @unique
  kind          String
  filePath      String      // relative to public/ (e.g. birthday-cards/<reservationId>/host.png)
  createdAt     DateTime    @default(now())
  inviteToken   InviteToken @relation(fields: [inviteTokenId], references: [id], onDelete: Cascade)

  @@index([kind])
  @@index([createdAt])
}

model TokenRedemption {
  id            String               @id @default(cuid())
  tokenId       String
  redeemedAt    DateTime             @default(now())
  by            String?
  device        String?
  location      String?
  reservationId String?
  reservation   BirthdayReservation? @relation(fields: [reservationId], references: [id])
  token         InviteToken          @relation(fields: [tokenId], references: [id])

  @@index([tokenId])
  @@index([redeemedAt])
  @@index([reservationId])
}

model CourtesyItem {
  id            String              @id @default(cuid())
  reservationId String
  type          String
  status        String              @default("pending")
  notes         String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  reservation   BirthdayReservation @relation(fields: [reservationId], references: [id])

  @@index([reservationId])
  @@index([type])
  @@index([status])
}

model PhotoDeliverable {
  id            String              @id @default(cuid())
  reservationId String
  kind          String              @default("group")
  url           String?
  status        String              @default("pending")
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  reservation   BirthdayReservation @relation(fields: [reservationId], references: [id])

  @@index([reservationId])
  @@index([status])
}

model PasswordResetOtp {
  id        String    @id @default(cuid())
  userId    String
  code      String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([code])
  @@index([expiresAt])
}

model DayBrief {
  id        String   @id @default(cuid())
  day       String   @unique
  title     String?
  show      String?
  promos    String?
  notes     String?
  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([day])
}

model Show {
  id                String     @id @default(cuid())
  title             String     @db.VarChar(120)
  slug              String     @unique @db.VarChar(140)
  status            ShowStatus @default(DRAFT)
  startsAt          DateTime
  endsAt            DateTime?
  slot              Int?       @db.SmallInt
  imageOriginalPath String
  imageWebpPath     String
  imageBlurData     String
  width             Int
  height            Int
  bytesOriginal     Int
  bytesOptimized    Int
  publishedAt       DateTime?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  details           String?
  notes             String?
  specialGuests     String?

  @@index([status, startsAt(sort: Desc)])
}

model ChecklistComment {
  id        String   @id
  userId    String
  day       String
  text      String
  createdAt DateTime @default(now()) @db.Timestamp(6)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([day])
  @@index([userId])
}

model ChecklistTaskComment {
  id        String   @id
  userId    String
  taskId    String
  day       String
  text      String
  createdAt DateTime @default(now()) @db.Timestamp(6)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([day])
  @@index([taskId], map: "ChecklistTaskComment_task_idx")
  @@index([userId])
}

model TaskComment {
  id        String   @id
  userId    String
  taskId    String
  day       String
  text      String
  createdAt DateTime @default(now()) @db.Timestamp(6)
  Task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([day])
  @@index([taskId, day])
  @@index([userId])
}

model birthdaypack {
  id       String  @id
  name     String? @unique
  qrcount  Int
  bottle   String
  perks    String
  active   Int     @default(1)
  featured Int     @default(0)
}

enum ShowStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}
